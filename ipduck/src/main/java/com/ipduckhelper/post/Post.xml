<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ipduckhelper.post">
	<insert id="crt_post" parameterType="com.ipduckhelper.post.Post">
		start transaction;
		insert into POST_TBL(MEM_ID, 
							 STAR_IDX, 
							 POST_TTL, 
							 POST_DATE, 
							 POST_CON) 
			values (#{mem_id}, 
					#{star_idx}, 
					#{post_ttl}, 
					SYSDATE(), 
					#{post_con}); 
		
		insert into POST_TAG_TBL(POST_IDX, 
								 TAG_NM) 
			values 
				<foreach collection="tag_nm_list" item="tag_nm" open="(" close=")" separator=",">
					LAST_INSERT_ID(), #{tag_nm.value}
				</foreach>
				
		commit;
	</insert>
	
	<insert id="crt_file" parameterType="com.ipduckhelper.post.Post">
		start transaction;
		insert into FILE_TBL(FILE_NM, 
							 FILE_PATH, 
						 	FILE_CRT_DATE) 
			values (#{file_nm}, 
					#{file_path}, 
					SYSDATE()); 
		insert INTO POST_FILE_TBL (POST_IDX, 
								   FILE_IDX) 
			values (#{post_idx}, 
					LAST_INSERT_ID());
					
		commit;
	</insert>
	
	<select id="srch_post_ttl_list" parameterType="com.ipduckhelper.post.Post" resultType="com.ipduckhelper.post.Post">
		select POST_IDX, 
			   MEM_ID, 
			   POST_TTL, 
			   POST_DATE, 
			   POST_HIT_CNT 
			from POST_TBL 
			where POST_TTL 
				like CONCAT('%', #{post_ttl}, '%') 
			limit #{offset}, 10;
	</select>
	
	<select id="srch_post_tag_list" parameterType="com.ipduckhelper.post.Post" resultType="com.ipduckhelper.post.Post">
		select PT.POST_IDX, 
			   PT.MEM_ID, 
			   PT.POST_TTL, 
			   PT.POST_DATE, 
			   PT.POST_HIT_CNT 
			from POST_TBL PT 
				inner join POST_TAG_TBL PTT 
					on PT.POST_IDX = PTT.POST_IDX 
			where PTT.TAG_NM = '태그이름' 
			limit #{offset}, 10;
		
	</select>
</mapper>